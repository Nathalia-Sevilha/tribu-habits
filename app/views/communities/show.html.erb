<div class=" community_style">

 <%= render partial: "shared/header",  locals: { zone: @community}  %>

  <section class="container" style="color: var(--community-text-color);">
    <%= link_to new_community_post_path(@community), class: "text-decoration-none text-reset" do%>
      <div class="btn btn-community mt-3 mx-3 p-3 d-flex justify-content-center align-items-center">
        <i class="fa-solid fa-plus"></i>
        <h6 class="fw-normal p-0 m-0 mx-1">Add a New Post</h6>
      </div>
    <%end%>
    <turbo-frame id="posts_list">
    <% @posts.each do |post| %>
        <div class="card_style">
        <div class="d-flex flex-row justify-content-between align-items-center mb-2">
          <div class="d-flex flex-row justify-content-start align-items-center">
              <% if post.user&.photo&.attached? %>
                <%= cl_image_tag post.user.photo.key, class: "user-posts-img" %>
              <% else %>
                <%= image_tag "user-avatar.svg", class: "user-posts-img" %>
              <% end %>
            <h5  class="m-0 mx-2 fw-normal h6" style="color: var(--community-title-color);"><%= post.user.username %> <%# here should be post writer username %></h5>
          </div>
          <div class="d-flex flex-row align-items-center">
             <small class="text-muted"><%= time_ago_in_words(post.created_at) %> ago</small>

            <% if post.user == current_user %>
              <div class="dropdown">
                <button class="bg-white btn-sm btn-light border-0" type="button" style="padding: 0 0 0 12px" id="dropdownMenu<%= post.id %>" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenu<%= post.id %>">
                  <li>
                    <%= link_to "Edit", edit_community_post_path(@community, post), class: "dropdown-item", data: { turbo: false } %>
                  </li>
                  <li>
                    <form action="<%= community_post_path(@community, post) %>" method="post" onsubmit="return confirm('Are you sure you want to delete this post?');">
                      <input type="hidden" name="_method" value="delete">
                       <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
                        <button type="submit" class="dropdown-item">
                          Delete
                        </button>
                    </form>
                  </li>
                </ul>
              </div>
            <% end %>

          </div>
        </div>
        <h3 class="h5" style="color: var(--community-title-color);"><%= post.title %></h3>
        <p><%= post.content %></p>

        <div class="d-flex flex-row justify-content-between">
         <%= link_to community_post_path(@community, post), class: "text-decoration-none text-reset", data: { turbo: false }  do %>
          <div class="d-flex flex-row justify-content-end align-items-center">
            <i class="fa-regular fa-comment-dots me-2"></i>
            <p class="my-0">Comments</p>
          </div>
        <% end %>

        <%= link_to "Add a comment", new_community_post_comment_path(@community, post),class: "fw-semibold text-decoration-none", style: "color: var(--orange) !important" , data: { turbo: false } %>
        </div>
      </div>
    <% end %>
    </turbo-frame>
  </section>
</div>


<script type="module">
  import * as bootstrap from "bootstrap"

  function initDropdowns(container = document) {
    container.querySelectorAll('[data-bs-toggle="dropdown"]').forEach((dropdownToggleEl) => {
      new bootstrap.Dropdown(dropdownToggleEl)
    })
  }

  document.addEventListener("turbo:load", () => initDropdowns())

  document.addEventListener("turbo:frame-load", (event) => {
    initDropdowns(event.target)
  })
</script>
